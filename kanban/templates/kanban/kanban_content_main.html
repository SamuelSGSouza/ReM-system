 
{% load static %}

<!-- Botão para formulários de edição de Kanban -->
<div class="taskboardapp-content ps-0">
    <div class="taskboardapp-detail-wrap">
        <header class="taskboard-header">
            <div class="d-flex align-items-center flex-1">
                <a class="taskboardapp-title link-dark" href="#">
                    <h1>
                        Kabans
                    </h1>
                </a>
                <button type="button" class="btn btn-primary ms-3 d-xxl-inline-block d-none flex-shrink-0" data-bs-toggle="modal" data-bs-target="#add_kanban">Adicionar Kanban</button>
                
            </div>
            <div class="d-md-flex flex-shrink-0 mx-3 d-none">
                <div class="d-flex align-items-center"><span class="d-md-inline d-none">Quantidade de Clientes:</span><span class="text-dark fs-5 fw-medium ps-2">{{qtd_clientes}}</span></div>
                <div class="v-separator"></div>
                <div class="d-flex align-items-center"><span class="d-md-inline d-none">Quantidade Kanbans:</span><span class="text-dark fs-5 fw-medium ps-2">{{request.session.qtd_kanbans}}</span></div>
                <div class="v-separator"></div>
            </div>
            <div class="taskboard-options-wrap flex-1 justify-content-end">
                <div class="taskboard-options-wrap flex-1 justify-content-end message-left">
                    {% include 'parcials/_messages.html' %}
                </div>
            </div>
        </header>
        <div class="taskboard-body taskboard-body-alt">
            <div>
                <div data-simplebar class="tasklist-scroll position-relative" style="margin-bottom: 1px!important">
                    <div id="tasklist_wrap" class="tasklist-wrap">


                        <!-- Clientes Iniciados -->
                        {% if qs_inicial %}
                        <div class="card card-simple card-flush spipeline-list ">
                            <div class="card-header card-header-action pb-4">
                                <div class="spipeline-handle pb-5 pt-2">
                                    <h6 class="text-uppercase fw-bold mb-4">Clientes Iniciados</h6>
                                    
                                </div>
                                <div>
                                    <span>
                                        <span class="spipeline-dot-sep">●</span>
                                        <span class="lead-count">
                                            {{qs_inicial.count}} Clientes
                                        </span>
                                    </span>
                                </div>
                            </div>

                            <div class="card-body">

                                <div id="i1" class="tasklist-cards-wrap">
                                    {% for cliente in qs_inicial %}
                                    <div class="card card-border spipeline-card">
                                        <div class="card-body">
                                            <div class="card-action-wrap">
                                                <a class="btn btn-xs btn-icon btn-rounded btn-light dropdown-toggle no-caret" aria-expanded="false" data-bs-toggle="dropdown" href="#" id="{{cliente.id}}" onclick="ClienteId(this.id)"><span class="icon"><span class="feather-icon"><i class="fa fa-solid fa-chevron-left"></i></span></span></a>
                                                <div role="menu" class="dropdown-menu dropdown-menu-end">
                                                    <a class="dropdown-item edit-tasklist" href="#" data-bs-toggle="modal" data-bs-target="#transferir_cliente"  >Transferir Cliente</a>
                                                    <a class="dropdown-item edit-tasklist" href="#" data-bs-toggle="modal" data-bs-target="#editar_cliente" data-nome="{{cliente.nome}}" data-contato_1 = "{{cliente.contato_1}}" data-contato_2 = "{{cliente.contato_2}}" data-contato_3 = "{{cliente.contato_3}}" data-comentario = "{{cliente.comentario}}" onclick="Preenche_Form(this.dataset)">Editar Cliente</a>
                                                    <a class="dropdown-item edit-tasklist" href="#" id="{{cliente.nome}}" onclick="Nome_Finalizado(this.id)" data-bs-toggle="modal" data-bs-target="#finaliza_cliente_modal" >Finalizar Cliente</a>
                                                </div>
                                            </div>
                                            
                                            <div class="media">
                                                
                                                <div class="media-body">
                                                    <div class="brand-name mt-1">Nome: {{cliente.nome}}</div>
                                                    <div class="price-estimation mt-1">Documento: {{cliente.documento}}</div>
                                                    <div class="price-estimation my-1">Contatos: 
                                                        <br>{{cliente.contato_1}}
                                                        {% if cliente.contato_2 %}
                                                         - {{cliente.contato_2}}
                                                        {% endif%}
                                                        {% if cliente.contato_3 %}
                                                         - {{cliente.contato_3}}
                                                        {% endif%}
                                                    </div>
                                                    <div class="price-estimation">
                                                        Tags: <br>
                                                        {% for tag in cliente.tags %}
                                                            <span class="tag {{tag.classe}}">{{tag.nome}}</span>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        <!-- /Clientes Iniciados -->

                        <!-- Kanbans -->
                        {% for kanban, clientes in kanban_clientes.items %}
                            {% if clientes %}
                            <div class="card card-simple card-flush spipeline-list ">
                                <div class="card-header card-header-action pb-4">
                                    <div class="spipeline-handle pb-5 pt-2">
                                        <h6 class="text-uppercase fw-bold mb-4">{{kanban}}</h6>
                                        <a class="btn btn-icon btn-flush-dark btn-rounded flush-soft-hover dropdown-toggle no-caret" href="#" data-bs-toggle="dropdown"><span class="icon"><span class="feather-icon"><i data-feather="more-horizontal"></i></span></span></a>
                                        <div class="card-action-wrap">
                                            <a class="btn btn-xs btn-icon btn-rounded btn-light dropdown-toggle no-caret" aria-expanded="false" data-bs-toggle="dropdown" href="#" id="{{cliente.id}}" onclick="ClienteId(this.id)"><span class="icon"><span class="feather-icon"><i class="fa fa-solid fa-bars"></i></span></a>
                                            <div role="menu" class="dropdown-menu dropdown-menu-end">
                                                <a class="dropdown-item edit-tasklist" href="#" data-bs-toggle="modal" data-bs-target="#excluir_kanban" data-kanban="{{kanban}}" onclick="Nome_Kanban(this.dataset.kanban)">Excluir Kanban</a>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <span>
                                            <span class="spipeline-dot-sep">●</span>
                                            <span class="lead-count">
                                                {{clientes|length}} Clientes
                                            </span>
                                        </span>
                                    </div>
                                </div>

                                <div class="card-body">

                                    <div id="i2" class="tasklist-cards-wrap">
                                        {% for cliente in clientes %}
                                        <div class="card card-border spipeline-card">
                                            <div class="card-body">
                                                <div class="card-action-wrap">
                                                    <a class="btn btn-xs btn-icon btn-rounded btn-light dropdown-toggle no-caret" aria-expanded="false" data-bs-toggle="dropdown" href="#" id="{{cliente.id}}" onclick="ClienteId(this.id)"><span class="icon"><span class="feather-icon"><i class="fa fa-solid fa-chevron-left"></i></span></a>
                                                    <div role="menu" class="dropdown-menu dropdown-menu-end">
                                                        <a class="dropdown-item edit-tasklist" href="#" data-bs-toggle="modal" data-bs-target="#transferir_cliente"  >Transferir Cliente</a>
                                                        <a class="dropdown-item edit-tasklist" href="#" data-bs-toggle="modal" data-bs-target="#editar_cliente" data-nome="{{cliente.nome}}" data-contato_1 = "{{cliente.contato_1}}" data-contato_2 = "{{cliente.contato_2}}" data-contato_3 = "{{cliente.contato_3}}" data-comentario = "{{cliente.comentario}}" onclick="Preenche_Form(this.dataset)">Editar Cliente</a>
                                                        <a class="dropdown-item edit-tasklist" href="#" id="{{cliente.nome}}" onclick="Nome_Finalizado(this.id)" data-bs-toggle="modal" data-bs-target="#finaliza_cliente_modal" >Finalizar Cliente</a>
                                                        <a class="dropdown-item edit-tasklist" href="#" id="{{cliente.nome}}" onclick="Nome_Finalizado(this.id)" data-bs-toggle="modal" data-bs-target="#adicionar_tags" >Editar Tags</a>
                                                    </div>
                                                </div>
                                                
                                                <div class="media">
                                                    
                                                        <div class="media-body">
                                                            <div class="brand-name mt-1">Nome: {{cliente.nome}}</div>
                                                            <div class="price-estimation mt-1">Documento: {{cliente.documento}}</div>
                                                            <div class="price-estimation my-1">Contatos: 
                                                                <br>{{cliente.contato_1}}
                                                                {% if cliente.contato_2 %}
                                                                 - {{cliente.contato_2}}
                                                                {% endif%}
                                                                {% if cliente.contato_3 %}
                                                                 - {{cliente.contato_3}}
                                                                {% endif%}
                                                            </div>
                                                            <div class="price-estimation">
                                                                Tags: <br>
                                                                {% for tag in cliente.tags %}
                                                                    <span class="tag {{tag.classe}}">{{tag.nome}}</span>
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                        
                                    </div>
                                </div>
                            </div>
                            
                            {% endif %}
                        {% endfor %}

                            
                        <div class="card card-simple card-border spipeline-list create-new-list">
                            <div class="card-header card-header-action">
                                <button class="btn btn-light btn-block bg-transparent border-0 text-primary"  data-bs-toggle="modal" data-bs-target="#add_kanban"><span><span class="icon"><span class="feather-icon"><i data-feather="plus"></i></span></span><span class="btn-text">Adicionar Kanban</span></span></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
                            
    <!-- Adicionar Kanban -->
    <div id="add_kanban" class="modal fade add-new-task" data-url="{% url 'criar_kanban' %}" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                    <h5 class="mb-4">Adicionar Kanban</h5>
                    <form id="kanban_form">
                        <div class="row gx-3">
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <label class="form-label">Nome do Kanban</label>
                                    <input class="form-control task-name"id="nome" name="nome" type="text"/>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer align-items-center">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" id="kanban_button" class="btn btn-primary btn-add-task" >Adicionar</button>
                        </div>
                    </form>
                </div>
                
            </div>
        </div>
    </div>
    <!-- /Adicionar Kanban -->
    
    <!-- excluir Kanbans -->
    <div id="excluir_kanban" class="modal fade edit-tasklist-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-md" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                    <h5 class="mb-4" >Excluir Kanban</h5>
                        <form>
                        <div class="row gx-3">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <h6>Você confirma que deseja finalizar o kanban  <b><span id="nome_exclui_kanban"></span></b>?<br> Todos os clientes deste kanban serão finalizados.</h6>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer align-items-center">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-danger btn-edit-tasklist" data-url="{% url 'excluir_kanban' %}" id="finaliza_kanban">Excluir</button>
                        </div>
                    </form>
                </div>
                
            </div>
        </div>
    </div>
    <!-- /excluir Kanbans -->
    

    <!-- Transferir Cliente -->
    <div id="transferir_cliente" class="modal fade edit-tasklist-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                    <h5 class="mb-4">Kanban de destino:</h5>
                    <form>
                        <div class="row gx-3">
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <select class="form-select" name="kanban_destino" id="kanban_destino">
                                        {% for k in kanbans  %}
                                        <option value="{{k}}">{{k}}</option>
                                        {% endfor %}
                                      </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer align-items-center">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-primary btn-edit-tasklist" data-url="{% url 'transfere_kanban' %}" id="transfere_kanban">Transferir</button>
                        </div>
                    </form>
                </div>
                
            </div>
        </div>
    </div>
    <!-- /Transferir Cliente -->

    <!-- Modificar Tags -->
    <div id="adicionar_tags" class="modal fade edit-tasklist-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                    <h5 class="mb-4">Selecione as novas Tags:</h5>
                    <form>
                        <div class="row gx-4">
                            <div class="col-sm-12" >
                                <div class="form-group" >
                                    <select class="form-control" multiple id="new_tags" name="tags" data-placeholder="Selecione as Tags" required>
                                        {% if request.session.tags %}
                                            {% for tag in request.session.tags %}
                                            <option value="{{tag.id}}" >{{tag.nome}}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer align-items-center">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-primary btn-edit-tasklist" data-url="{% url 'editar_tags' %}" id="add_tags">Editar</button>
                        </div>
                    </form>
                </div>
                
            </div>
        </div>
    </div>
    <!-- /Modificar  tags -->

    <!-- Editar Cliente -->
    <div id="editar_cliente" class="modal fade edit-tasklist-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-md" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                    <h5 class="mb-4" id="nome_cliente_form">Editar Cliente</h5>
                        <form>
                        <div class="row gx-3">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="form-label">Contato 1</label>
                                    <input name="contato_1" id="contato_1_field" class="form-control" onfocusout="define_contato_1(this.value)">
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="form-label">Contato 2</label>
                                    <input name="contato_2" id="contato_2_field" class="form-control" onfocusout="define_contato_2(this.value)">
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="form-label">Contato 3</label>
                                    <input name="contato_3" id="contato_3_field" class="form-control" onfocusout="define_contato_3(this.value)">
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="form-label">Comentário</label><br>
                                    <textarea id="comentario_form" name="comentario_form" rows="5" cols="50" onfocusout="Define_Comentario(this.value)"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer align-items-center">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-primary btn-edit-tasklist" data-url="{% url 'edita_cliente' %}" id="edita_cliente">Editar</button>
                        </div>
                    </form>
                </div>
                
            </div>
        </div>
    </div>
    <!-- /Editar Cliente -->

    <!-- Finaliza Cliente -->
    <div id="finaliza_cliente_modal" class="modal fade edit-tasklist-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-md" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                    <h5 class="mb-4" >Finalizar Cliente</h5>
                        <form>
                        <div class="row gx-3">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <h6>Você confirma que deseja finalizar o cliente  <b><span id="nome_finaliza_cliente"></span></b>?</h6>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer align-items-center">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-danger btn-edit-tasklist" data-url="{% url 'finaliza_cliente' %}" id="finaliza_cliente">Finalizar</button>
                        </div>
                    </form>
                </div>
                
            </div>
        </div>
    </div>
    <!-- /Finaliza Cliente -->

</div>
<script>
    //Botão para editar Kanban
    window.idBotaoClicado =0;

    function botaoClicado(e){
        window.idBotaoClicado= e;
    }

    //Botão para editar Cliente
    window.clienteID = 0;

    function ClienteId(e){
        window.clienteID= e;
    }

    //Botão para Editar Kanban
    function DefineIdKanban(e){
        window.NameKanban = e;
        console.log(e)
    }

    //Preenchendo Formulário de Edição de Cliente
    window.contato_1_var = 0;
    window.contato_2_var = 0;
    window.contato_3_var = 0;
    window.comentario_var = "";
    function Define_Comentario(e){
        window.comentario_var= e;
    }
    function define_contato_1(e){
        window.contato_1_var= e;
    }
    function define_contato_2(e){
        window.contato_2_var= e;
    }
    function define_contato_3(e){
        window.contato_3_var= e;
    }
    
    function Preenche_Form(dataset){
        var nome = dataset.nome
        var contato_1 = dataset.contato_1;
        var contato_2 = dataset.contato_2;
        var contato_3 = dataset.contato_3;
        var comentario = dataset.comentario;
        if (comentario == "None"){
            comentario = "";
        }
        window.contato_1_var = contato_1;
        window.contato_2_var = contato_2;
        window.contato_3_var = contato_3;
        window.comentario_var = comentario;
        //modificando nome
        document.getElementById("nome_cliente_form").innerHTML = nome;

        //modificando contato 1
        document.getElementById("contato_1_field").placeholder = contato_1;
        document.getElementById("contato_1_field").value = contato_1;
        //modificando contato 2
        document.getElementById("contato_2_field").placeholder = contato_2;
        document.getElementById("contato_2_field").value = contato_2;

        //modificando contato 1
        document.getElementById("contato_3_field").placeholder = contato_3;
        document.getElementById("contato_3_field").value = contato_3;

        //modificando comentario
        document.getElementById("comentario_form").placeholder = comentario;
        document.getElementById("comentario_form").value = comentario;
    }

    //Preenchendo finalização do cliente
    function Nome_Finalizado(nome, id){
        document.getElementById("nome_finaliza_cliente").innerHTML = nome;
    }
    //Preenchendo Exclusão do Kanban
    function Nome_Kanban(nome){
        window.NomeKanban = nome;
        document.getElementById("nome_exclui_kanban").innerHTML = nome;
    }

</script>

<!-- Envio ajax de Formulários-->
<script>
    //Criação de Kanban
    $("#kanban_button").click(function () {
        var url = document.getElementById('add_kanban').dataset.url;
        var dados = "?nome=" + $("#nome").val();
        fetch(
            url + dados
        ).then(response => {
            recarrega_main();
        });
        // $.ajax({
        //     url: url,
        //     data: {
        //         nome: $("#nome").val(),
        //     },
        //     dataType: "json",
        //     type: "GET",
        //     success: function (data) {
        //         recarrega_main();
        //     }
        // });
    });

    //Edição de Kanban
    $("#editar_kanban_button").click(function () {
        var url = document.getElementById('editar_kanban_button').dataset.url;
        var dados = "?novo_nome=" + $("#novo_nome_kanban").val() + "&nome_antigo=" + window.NameKanban;
        fetch(
            url + dados
        ).then(response => {
            recarrega_main();
        });
    });

    //Editando Cliente
    $("#edita_cliente").click(function () {
        var url = document.getElementById('edita_cliente').dataset.url;
        var contato_1 = window.contato_1_var;
        var contato_2 = window.contato_2_var;
        var contato_3 = window.contato_3_var;
        var comentario = window.comentario_var;
        $.ajax({
            url: url,
            data: {
                contato_1: contato_1,
                contato_2: contato_2,
                contato_3: contato_3,
                comentario: comentario,
                id_cliente: window.clienteID
            },
            dataType: "json",
            type: "GET",
            success: function (data) {
                recarrega_main();
            }
        });
    });
    //Fim de criação de Kanban

    //Tranferência de Kanban do cliente
    $("#transfere_kanban").click(function () {
        var url = document.getElementById('transfere_kanban').dataset.url;
        var destino = document.getElementById('kanban_destino').value;
        $.ajax({
            url: url,
            data: {
                kanban_destino: destino,
                id_cliente: window.clienteID
            },
            dataType: "json",
            type: "GET",
            success: function (data) {
                recarrega_main();
            }
        });
    });

    //Adicionar Tags
    $("#add_tags").click(function () {
        var url = document.getElementById('add_tags').dataset.url;
        var tags = $('#new_tags').val();
        var dados = "?id_cliente=" + window.clienteID + "&tags=" + tags;
        fetch(
            url + dados
        ).then(response => {
            recarrega_main();
        });
        console.log(tags);
        // $.ajax({
        //     url: url,
        //     data: {
        //         tags: tags,
        //         id_cliente: window.clienteID
        //     },
        //     dataType: "json",
        //     type: "GET",
        //     success: function (data) {
        //         recarrega_main();
        //     }
        // });
    });

    //Finaliza Cliente
    $("#finaliza_cliente").click(function () {
        var url = document.getElementById('finaliza_cliente').dataset.url;
        $.ajax({
            url: url,
            data: {
                id_cliente: window.clienteID
            },
            dataType: "json",
            type: "GET",
            success: function (data) {
                recarrega_main();
            }
        });
    });

    //Exclui Kanban
    $("#finaliza_kanban").click(function () {
        var url = document.getElementById('finaliza_kanban').dataset.url;
        $.ajax({
            url: url,
            data: {
                nome_kanban: window.NomeKanban
            },
            dataType: "json",
            type: "GET",
            success: function (data) {
                recarrega_main();
            }
        });
    });
</script>
<script src="{% static 'js/lc_select.js' %}"></script>
    
<script>
    const select = document.querySelector('select[name=simple]');
    new lc_select(select, {
        wrap_width: '100%',
        min_for_search: 3,
        pre_placeh_opt: true,
    });

    new lc_select('select[name="tags"]', {
        wrap_width : '100%',
        enable_search : false,
        max_opts : 20,
    });
</script>
<span id="{{request.session.personal_id}}" onload="DefinePersonalId(this.id)" style="display:none!important"></span>